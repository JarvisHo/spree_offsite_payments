<%= image_tag "billing_integrations/wxpay.png" %>
<br/>
<% if payment  %>
  <% if payment.prepay_id %>
    <%= javascript_tag do %>
    function onBridgeReady(){
      WeixinJSBridge.invoke(
        'getBrandWCPayRequest', {
        "appId": '<%= @wcpay['appId'] %>',     //公众号名称，由商户传入
        "timeStamp": '<%= @wcpay['timeStamp'] %>',         //时间戳，自1970年以来的秒数
        "nonceStr": '<%= @wcpay['nonceStr'] %>', //随机串
        "package": '<%= @wcpay['package'] %>', // prepay_id
        "signType": '<%= @wcpay['signType'] %>',         //微信签名方式                :
        "paySign": '<%= @wcpay['paySign']  %>' //微信签名
        },
        function(res){     
          if(res.err_msg == "get_brand_wcpay_request:ok" ) {window.location = '<%= @goto_page_when_paid %>';} 
          // else {alert(res.err_msg);}
        }); 
      }
      if (typeof WeixinJSBridge == "undefined"){
        if( document.addEventListener ){
          document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
        }else if (document.attachEvent){
          document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
          document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
        }
      }else{
        onBridgeReady();
      };
      <% end %>
  <% else %>
    <%= image_tag("#{payment_qrcode_url(payment_id: payment.id)}.png", size: "200x200") if payment %>
    <%= javascript_tag do %>
      var onPaidEvent = function() {
      var source = new EventSource('<%= payment_status_path(payment_id: payment.id) %>');

      source.addEventListener('order_paid', function(e) {
      // console.log('<%= spree.order_path(order.number) %>');
      window.location = '<%= spree.order_path(order.number) %>';
      });
      };
      onPaidEvent();
    <% end %>
  <% end %>
<% end %>
